# DocMaskRefine 模型框架与损失函数策略文档

## 概述

DocMaskRefine是一个专门针对文档图像阴影去除的深度学习模型，采用双阶段架构设计，结合Transformer注意力机制和专门的边界处理模块，有效解决文档阴影去除中的黑边伪影问题。

## 模型架构

### 总体框架

```
输入图像 → 掩码生成阶段 → 精炼阶段 → 输出结果
   ↓           ↓             ↓
灰度图    阴影掩码   最终RGB图像
RGB图
```

### 第一阶段：掩码生成（mask.py）

#### 核心组件：RestormerMask
- **基础结构**：Transformer架构，专为图像恢复任务设计
- **输入**：灰度图像（1通道）
- **输出**：双通道掩码（原始掩码+精炼掩码）

#### 技术亮点
1. **ConvAttention（卷积注意力）**
   - 采用CvT风格的卷积投影生成QKV
   - 多头注意力机制，保持空间结构
   - 归一化处理增强稳定性

2. **GDFN（门控前馈网络）**
   - 双分支设计：GELU激活门控机制
   - 深度可分离卷积提高效率
   - 特征扩展因子2.66

3. **MaskPredictor（掩码预测器）**
   - 轻量级CNN结构
   - Sigmoid输出保证掩码范围[0,1]

### 第二阶段：图像精炼（refine.py）

#### 核心组件：RefineUNetCoord
- **基础结构**：U-Net + 坐标注意力 + 文档边界注意力
- **输入**：5通道（2通道掩码+3通道RGB图像）
- **输出**：3通道RGB精炼结果

#### 技术亮点
1. **U-Net架构**
   - 编码器-解码器对称结构
   - 跳跃连接保持高频细节
   - 双线性上采样或转置卷积

2. **Coordinate Attention（坐标注意力）**
   - 坐标信息嵌入
   - 水平和垂直方向特征融合
   - 轻量级设计，效率与效果平衡

3. **跳跃连接优化**
   - 多尺度特征融合
   - 空间尺寸自适应对齐
   - 特征维度匹配

### 文档边界注意力模块（document_boundary.py）

#### 设计目标
专门处理文档阴影去除中的边界问题，包括黑边消除、边缘平滑、文字保护等。

#### 核心架构
1. **EdgeDetectionBranch（边缘检测分支）**
   ```
   输入特征 → 卷积提取 → 边缘概率图
       ↓
   Sobel算子（可选融合）
   ```

2. **DocumentRegionBranch（文档区域分析分支）**
   - 文字区域 vs 背景区域分类
   - 双通道概率输出
   - 为边界处理提供区域指导

3. **BoundarySmoothingBranch（边界平滑分支）**
   
   - 高斯平滑核生成
   - 自适应平滑权重
   - 边缘扩展与渐变处理
   
4. **FeatureFusionModule（特征融合模块）**
   - 原始特征与平滑特征自适应融合
   - 边界背景区域与文字区域差异化处理
   - 保护文字边缘，平滑背景过渡

## 损失函数策略

### 核心设计理念
针对文档阴影去除三大挑战：
1. 阴影边界黑边问题
2. 颜色一致性保持
3. 平滑自然过渡

### 复合损失函数架构

#### 主要损失组件
1. **边缘感知损失（EDGE_WEIGHT: 0.7）**
   - Sobel算子提取边缘
   - 重点关注边界区域重建质量
   - 直接解决黑边问题

2. **阴影边界损失（BOUNDARY_WEIGHT: 0.9）**
   - 形态学操作精确定位边界
   - 边界区域加权重建损失
   - 核心边界优化机制

3. **梯度损失（GRADIENT_WEIGHT: 0.4）**
   - 水平和垂直梯度一致性
   - 确保平滑过渡效果
   - 防止阶梯状伪影

4. **透明度损失（TRANSPARENCY_WEIGHT: 0.1）**
   - 渐变掩码生成
   - 边缘透明效果
   - 自然过渡增强

5. **感知损失（PERCEPTUAL_WEIGHT: 0.2）**
   - VGG特征匹配（或YUV颜色空间）
   - 高层语义一致性
   - 颜色协调优化

6. **直方图损失（HISTOGRAM_WEIGHT: 0.2）**
   - 全局颜色分布一致性
   - 背景颜色保持
   - 统计特征匹配

7. **结构相似性损失（SSIM_WEIGHT: 0.3）**
   - 亮度、对比度、结构保持
   - 整体图像质量

8. **基础MSE损失（MSE_WEIGHT: 1.0）**
   - 像素级重建基准

### 损失权重配置策略

```
总损失 = MSE + 0.3×SSIM + 0.7×Edge + 0.4×Gradient +
         0.9×Boundary + 0.1×Transparency +
         0.2×Perceptual + 0.2×Histogram
```

#### 权重设计原理
- **边界处理优先**：Edge + Boundary = 1.6（最高权重组合）
- **平滑度保证**：Gradient + Transparency = 0.5
- **质量维护**：SSIM + Perceptual = 0.5
- **全局一致性**：Histogram = 0.2
- **基础重建**：MSE = 1.0

## 模型优势

### 技术创新
1. **双阶段架构**：掩码指导的精炼流程
2. **Transformer注意力**：全局上下文建模
3. **专门边界模块**：文档感知的边缘优化
4. **复合损失设计**：多维度质量保证

# 框架名称

## 掩码生成阶段（Mask Generation Stage, mask.py）

### **Shadow-Attentive Mask Generator (SAMG)**

Shadow-Attentive Mask Generator (SAMG) 利用 Transformer 架构，通过卷积注意力机制生成高质量的双通道阴影掩码，为后续精炼阶段提供精确的阴影区域指导。

## 图像精炼阶段（Image Refinement Stage, refine.py）

### **Document-Guided Refinement Network (DGRN)**

Document-Guided Refinement Network (DGRN) 基于优化的 U-Net 架构，结合坐标注意力和文档边界注意力，生成高质量的去阴影 RGB 图像，显著提升视觉质量和结构相似性。

------

## 复合损失函数

## **Multi-Scale Document-Aware Loss (MSDAL)**

ShaDocFormer 采用 Multi-Scale Document-Aware Loss (MSDAL) 作为优化目标，通过结合边缘感知、阴影边界、梯度、透明度、感知、直方图、SSIM 和 MSE 损失，全面优化文档阴影去除的视觉质量和结构相似性。

# 消融实验

## 1、模型消融



## 2、损失函数消融